<!DOCTYPE html style="height:100%;width:100%;overflow-x:hidden">
<html>
<head>
    <meta charset="UTF-8">
    <title>DMaS-McGill | Kam1n0 </title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- bootstrap 3.0.2 -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <!-- font Awesome -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <!-- Ionicons -->
    <link href="css/ionicons.min.css" rel="stylesheet" type="text/css"/>
    <!-- Theme style -->
    <link href="css/AdminLTE.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon"/>

    <!-- style sheet for tipsy.css tool tips-->
    <link href="css/tipsy.css" rel="stylesheet" type="text/css"/>


     <!-- bootstrap slider -->
    <link href="css/bootstrap-slider/slider2.css" rel="stylesheet" type="text/css"/>

    <!-- bootstrap tree -->
    <link href="css/tree.css" rel="stylesheet" type="text/css"/>


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <style>


        .node rect {
        stroke: #333;
        fill: #fff;
        }

        .edgePath path {
        fill: #333;
        stroke-width: 1.5px;
        }

        /* This styles the body of the tooltip */
        .tipsy {
        font-size: 1.1em;
        test-align: left;
        }

        .progress {
        background-color: #2B084E;
        }

        .line-nums {
        font-size: 13px;
        line-height: 13px;
        padding: 10px 4px;
        font-family: monospace;
        background: #EEE;
        position: absolute;
        width: 30px;
        left: -0.5px;
        bottom: 0;
        top: 15px;
        text-align: right;
        margin-left: 5px;
        }

        .glyphicon-refresh-animate {
        -animation: spin .7s infinite linear;
        -webkit-animation: spin2 .7s infinite linear;
        }

        @-webkit-keyframes spin2 {
        from {
        -webkit-transform: rotate(0deg);
        }
        to {
        -webkit-transform: rotate(360deg);
        }
        }

        @keyframes spin {
        from {
        transform: scale(1) rotate(0deg);
        }
        to {
        transform: scale(1) rotate(360deg);
        }
        }

        #headerTitle {
        font-family: 'Antic Slab', serif;
        font-size: 100px;
        color: #DDCCEE;
        }

        .lead {
        color: #DDCCEE;
        }

        /* Custom container */
        .container-full {
        margin: 0 auto;
        width: 100%;
        min-height: 100%;
        background-color: #110022;
        color: #eee;
        overflow: hidden;
        }

        .container-full a {
        color: #efefef;
        text-decoration: none;
        }

        .v-center {
        margin-top: 7%;
        }

        #inputbox {

        /* The following three rules make a difference in the script */
        overflow: hidden;
        line-height: 18px;
        font-size: 15px;

        font-family: 'Antic Slab', serif;
        color: rgb(1, 255, 45);
        max-width: 850px;
        min-width: 850px;
        min-height: 200px;
        width: 850px;
        overflow: auto;
        background-color: black;
        }

        .input-container {
        position: relative;
        display: inline-block;
        }

        .line-nums {
        font-size: 15px;
        color: #DDCCEE;
        line-height: 18px;
        padding: 10px 4px;
        font-family: monospace;
        background-color: rgb(43, 8, 78);
        position: absolute;
        width: 29px;
        left: -36px;
        bottom: 0;
        top: 0;
        text-align: right;
        }

        .glyphicon-refresh-animate {
        -animation: spin .7s infinite linear;
        -webkit-animation: spin2 .7s infinite linear;
        }

        @-webkit-keyframes spin2 {
        from {
        -webkit-transform: rotate(0deg);
        }
        to {
        -webkit-transform: rotate(360deg);
        }
        }

        @keyframes spin {
        from {
        transform: scale(1) rotate(0deg);
        }
        to {
        transform: scale(1) rotate(360deg);
        }
        }

        .logoImg {
        height: 80px;
        position: relative;
        top: -30px;
        }

        /* layout.css Style */
        .upload-drop-zone {
        height: 200px;
        border-width: 2px;
        margin-bottom: 20px;
        }

        /* skin.css Style*/
        .upload-drop-zone {
        color: rgb(1, 255, 45);
        background-color: black;
        border-style: dashed;
        border-color: #534661;
        line-height: 200px;
        text-align: center
        }

        .upload-drop-zone.drop {
        color: rgb(1, 255, 45);
        border-color: #222;
        }

        .slider.slider-vertical {
        height: 100%;
        }

        /* slider color*/

        #GC .slider-handle {
        border-radius: 0%;
        margin-left: 0px;
        margin-top: 0px;
        width: 10px;
        }

        /* diff text */
        td.diff-line-content {
        padding-left: 20px;
        padding-right: 10px;
        vertical-align: top;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 12px;
        }

        td.diff-line-content.remove {
        background-color: #ffecec;
        }

        td.diff-line-content.add {
        background-color: #eaffea;
        }

        td.diff-line-content.empty {
        background-color: #fafafa;
        min-height: 20px;
        }

        td.diff-line-num {
        width: 6%;
        min-width: 50px;
        white-space: nowrap;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 12px;
        line-height: 18px;
        color: rgba(0, 0, 0, 0.3);
        vertical-align: top;
        text-align: right;
        border: solid #eee;
        border-width: 0 1px 0 0;
        cursor: pointer;
        border-left-width: 1px;
        padding-left: 10px;
        padding-right: 10px;
        }

        td.diff-line-num.selected {
        background-color: rgba(255, 165, 0, 0.1);
        }
        td.diff-line-num.empty.selected {
        background-color: rgba(255, 165, 0, 0.1);
        }

        td.diff-line-num:hover {
        color: rgba(0, 0, 0, 0.67);
        }

        td.diff-line-num.empty {
        background-color: #fafafa;
        height: 20px;
        }

        span.m {
        color: #a71d5d;
        display: inline-block;
        width: 50px;
        }

        table.block {
        border-color: gray;
        display: table;
        width: 100%;
        border-spacing: 2px;
        border-right: solid 1px #eee;
        }

        div.sep {
        background-color: #fafafa;
        color: rgba(0, 0, 0, 0.53);
        padding-left: 10px;
        line-height: 18px;
        font-size: 12px;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        border-right: solid 1px #eee;
        border-left: solid 3px #837979;
        }

        span.commenter {
        position: relative;
        z-index: 5;
        float: right;
        font-size: 16px;
        width: 20px;
        height: 20px;
        margin: -1px -25px -1px -10px;
        line-height: 20px;
        color: #fff;
        text-align: center;
        text-indent: 0;
        cursor: pointer;
        background-color: orange;
        border-radius: 3px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        opacity: 0;
        -webkit-transform: scale(0.8, 0.8);
        -ms-transform: scale(0.8, 0.8);
        transform: scale(0.8, 0.8);
        -webkit-transition: -webkit-transform 0.1s ease-in-out;
        transition: transform 0.1s ease-in-out;
        }

        span.commenter.selected {
        opacity: 1.0;
        transform: scale(1.0, 1.0);
        }

        div.cmbox{
        color: rgba(0, 145, 22, 1);
        padding-left: 10px;
        line-height: 18px;
        font-size: 12px;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        border-left: solid 2px rgba(0, 141, 15, 0.44);
        }

        div.cmbox>p{
        margin-bottom:0px;
        }

        tr.comrow{

        }

        span.delete{
        font-size: 13px;
        margin-left:4px;
        cursor: pointer;
        color: rgb(188, 188, 188);
        }

    </style>
</head>
<body>
<div style="height:100%">
    <section class="col-lg-6 connectedSortable ui-sortable" style="height:100%">
        <div class="box box-info collapsed-box" id="flowGraphSource" style="height:100%">
            <div class="box-header" id="headerSource">
                <i class="fa fa-cloud"></i>
                <h3 class="box-title" style="font-size:15px">Flow Graph (Target)</h3>
            </div>
            <div class="box-body no-padding">
                <div id="chartSource"
                     style="width:100%;min-height: 100px;overflow-y: hidden;overflow-x: hidden">
                    <svg style="width:100%; background-color:white; padding:0px;">
                        <g/>
                    </svg>
                    <div style="position: absolute;top: 30px;right: 0;" id="sliderSource">
                        <input type="text" value="0" class="slider form-control" data-slider-min="0"
                               data-slider-max="100" data-slider-step="1" data-slider-value="-5"
                               data-slider-orientation="vertical" data-slider-selection="after"
                               data-slider-tooltip="hide" data-slider-id="GC">
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="col-lg-6 connectedSortable ui-sortable" style="height:100%">
        <div class="box box-warning collapsed-box" id="flowGraphTarget" style="height:100%">
            <div class="box-header" id="headerTarget">
                <i class="fa fa-cloud"></i>
                <h3 class="box-title" style="font-size:15px">Flow Graph (Source)</h3>
            </div>
            <div class="box-body no-padding">
                <div id="chartTarget"
                     style="width:100%;min-height: 100px;overflow-y: hidden;overflow-x: hidden">
                    <svg style="width:100%; background-color:white; padding:0px;">
                        <g/>
                    </svg>
                    <div style="position: absolute;top: 30px;right: 0;"  id="sliderTarget">
                        <input type="text" value="0" class="slider form-control" data-slider-min="0"
                               data-slider-max="100" data-slider-step="1" data-slider-value="-5"
                               data-slider-orientation="vertical" data-slider-selection="after"
                               data-slider-tooltip="hide" data-slider-id="GC">
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>


<!-- jQuery 2.0.2 -->
<script src="js/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<!-- DATA TABES SCRIPT -->
<script src="js/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>

<!-- Bootstrap -->
<script src="js/bootstrap.min.js" type="text/javascript"></script>

<!-- Forcegraph -->
<script src="js/d3.v3.min.js"></script>
<script src="js/dagre-d3.js"></script>
<script src="js/jquery.tipsy.js"></script>

<!-- Convex hull -->
<script src="js/graham_scan.min.js"></script>

<!-- Bootstrap slider -->
<script src="js/plugins/bootstrap-slider/bootstrap-slider2.js" type="text/javascript"></script>



<!-- Page script -->
<script type="text/javascript">

    var clonePartColors = d3.scale.category20c().range();

    function resize(){
        var docHeight = $(window).height();
        var div1Height = $('#headerSource').height();
        var div2Height = docHeight - div1Height - 15;
        $('#chartSource').css('height', div2Height);
        $('#sliderSource').css('height', div2Height);
        div1Height = $('#headerTarget').height();
        div2Height = docHeight - div1Height - 15;
        $('#chartTarget').css('height', div2Height);
        $('#sliderTarget').css('height', div2Height);
    }

    $(document).ready(function() {
        resize();
    });

    $(window).on("resize", function () {
       resize();
    }).trigger("resize");


    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    var QueryString = function () {
        // This function is anonymous, is executed immediately
        var query_string = {};
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            // If first entry with this name
            if (typeof query_string[pair[0]] === "undefined") {
                query_string[pair[0]] = pair[1];
                // If second entry with this name
            } else if (typeof query_string[pair[0]] === "string") {
                var arr = [query_string[pair[0]], pair[1]];
                query_string[pair[0]] = arr;
                // If third or later entry with this name
            } else {
                query_string[pair[0]].push(pair[1]);
            }
        }
        return query_string;
    }();

    var p_a;
    var p_b;


    function seeFlow(pairIndex, dataParsed) {

        p_a = pairIndex[0];
        p_b = pairIndex[1];
        var p_b_param = dataParsed.results[p_a].clones[p_b].functionIdStr;


        var g = new dagreD3.graphlib.Graph({multigraph: true}).setGraph({});

        var pa_fun = dataParsed.results[p_a].function;

        /*$.ajax({
            type: 'GET',
            dataType: 'json',
            url: "FunctionFlow",
            data: {
                fid: p_b_param
            },
            success: function (data) {
                var pb_fun = data;

                drawFlow(pb_fun, 'flowGraphTarget', dataParsed.results[p_a].clones[p_b].clonedParts);
                drawTextDiff(pa_fun, pb_fun);
                drawCloneTextDiff(pa_fun, pb_fun, dataParsed.results[p_a].clones[p_b].clonedParts);
            }
        }); // end ajax
        */


        drawFlow(pa_fun, 'flowGraphSource', dataParsed.results[p_a].clones[p_b].clonedParts);

        external.GetFunc(p_b_param, callBack);
    }

    function callBack(funcb){
        drawFlow($.parseJSON(funcb), 'flowGraphTarget', gd.results[p_a].clones[p_b].clonedParts);
    }

    function drawFlow(func, placeholderId, cloneSets) {
        var g = new dagreD3.graphlib.Graph({multigraph: true}).setGraph({});
        var t_nodes = func.nodes;
        var t_links = func.links;

        for (var i = 0; i < t_nodes.length; ++i) {
            var node = t_nodes[i];
            g.setNode(node.blockID,
                    {
                        label: node.srcCodes.join("<br>"), style: "fill:white",
                        labelType: "html", labelStyle: "background-color:white;color:black;text-align: left;"
                    });
        }

        t_links.forEach(function (link) {
            g.setEdge(link.source, link.target, {label: "call"});
        });

        // Set some general styles
        g.nodes().forEach(function (v) {
            var node = g.node(v);
            node.rx = node.ry = 5;
        });

        var svg = d3.select("#" + placeholderId).select("svg")

        var inner = svg.select("g");
        inner.selectAll("*").remove();
        var area = inner.append("g");

        // Create the renderer
        var render = new dagreD3.render();

        // Run the renderer. This is what draws the final graph.
        render(inner, g);

        var graphHeight = g.graph().height;
        var translate = [0, 0];
        var scale = 1.0;

        // set slider:
        var slider = $("#" + placeholderId + " input.slider")
                .slider({min: 0, max: 100})
                .data('slider');

        // Set up zoom support
        var zoom = d3.behavior.zoom().on("zoom", function () {

            translate = d3.event.translate;
            var top = d3.event.translate[1];
            scale = d3.event.scale;

            var slideVal = top / (graphHeight * scale - 800) * -100.0;
            slider.setValue(slideVal);
            inner.attr("transform", "translate(" + d3.event.translate + ")" +
                    "scale(" + d3.event.scale + ")");
        });
        svg.call(zoom);


        slider.on('slide', function (slideEvt) {
                    translate[1] = slider.getValue() / (-100.0) * (graphHeight * scale - 800);
                    //console.log(translate);
                    zoom
                            .translate(translate)
                            .scale(scale)
                            .event(svg);
                }
        );

        zoom.translate(translate).scale(scale).event(svg);


        // svg.attr('height', $(document).height() - 50 - 52);


        var gnodes = inner.selectAll(".node").on("dblclick",
                function (d) {

                })
                .on("mousedown",
                function (d) {

                })
                .on("mousedrag",
                function (d) {

                })
                .on("mouseup",
                function (d) {


                });

//setup tool tips for links
        inner.selectAll("g.edgePath")
                .attr("title", function (v) {
                    var targ = v.w;
                    var node = g.node(targ);
                    return node.label;
                })
                .each(function (v) {
                    $(this).tipsy({
                        trigger: 'hover',
                        gravity: 'e',
                        follow: 'y',
                        opacity: 0.8, html: true
                    });
                });

//highlight the link when mouse hover
        inner.selectAll("g.edgePath").style("stroke", "black");
        inner.selectAll("g.edgePath").on("mouseover", function (d) {
            inner.selectAll("g.edgePath").style("stroke", "black");
            d3.select(this).style("stroke", "green");
        });

// draw clone boundaries
        var lineFunction = d3.svg.line()
                .x(function (d) {
                    return d.x;
                })
                .y(function (d) {
                    return d.y;
                })
                .interpolate("monotone");

        var color = 'white';
        var index = 0;
        for (var j = 0; j < cloneSets.length; ++j) {
            var cloneSet = cloneSets[j];
            color = clonePartColors[index];
            var convexHullSource = new ConvexHullGrahamScan();
            for (var k = 0; k < cloneSet.length; ++k) {
                var clonePair = cloneSet[k];
                inner.selectAll("g.node").each(function (i, d) {
                    if (i == clonePair._1 || i == clonePair._2) {
                        var m = this.transform.animVal.getItem(0)['matrix'];
                        var re = this.children[0];

                        var x1 = re.x.animVal.value + m['e'];
                        var y1 = re.y.animVal.value + m['f'];
                        convexHullSource.addPoint(x1 - 5, y1 - 5);
                        convexHullSource.addPoint(x1 - 5, y1 + re.height.animVal.value + 5);
                        convexHullSource.addPoint(x1 + re.width.animVal.value + 5, y1 + re.height.animVal.value + 5);
                        convexHullSource.addPoint(x1 + re.width.animVal.value + 5, y1 - 5);
                    }
                });
            }
            var hullPointsSource = convexHullSource.getHull();
            hullPointsSource.push(hullPointsSource[0]);
            area.append("path")
                    .attr("d", lineFunction(hullPointsSource))
                    .attr("stroke", "blue")
                    .attr("stroke-width", 2)
                    .attr("fill", color)
                    .style("fill-opacity", 0.3).style("stroke-dasharray", ("3, 3"));
            index++;
        }


    }

     var gd;

     window.onload = function(){
        //var dataParsed = $.parseJSON(window.params);
        //CreateCloneGraph(dataParsed);
        // alert(window.GData);
        //alert(window.params);
        gd =  $.parseJSON(window.GData);
        seeFlow(window.params,gd);
     }





</script>
</body>
</html> 