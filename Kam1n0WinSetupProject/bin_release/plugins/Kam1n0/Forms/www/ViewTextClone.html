<!DOCTYPE html >
<html  style="height:100%">
<head>
    <meta charset="UTF-8">
    <title>DMaS-McGill | Kam1n0 </title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- bootstrap 3.0.2 -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <!-- font Awesome -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <!-- Ionicons -->
    <link href="css/ionicons.min.css" rel="stylesheet" type="text/css"/>


    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon"/>

    <!-- style sheet for tipsy.css tool tips-->
    <link href="css/tipsy.css" rel="stylesheet" type="text/css"/>


    <!-- bootstrap slider -->
    <link href="css/bootstrap-slider/slider2.css" rel="stylesheet" type="text/css"/>

    <!-- bootstrap tree -->
    <link href="css/tree.css" rel="stylesheet" type="text/css"/>
     <!-- bootstrap markdown -->
    <link href="css/bootstrap-markdown/bootstrap-markdown.min.css" rel="stylesheet" type="text/css"/>


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <style>


        .node rect {
        stroke: #333;
        fill: #fff;
        }

        .edgePath path {
        fill: #333;
        stroke-width: 1.5px;
        }

        /* This styles the body of the tooltip */
        .tipsy {
        font-size: 1.1em;
        test-align: left;
        }

        .progress {
        background-color: #2B084E;
        }

        .line-nums {
        font-size: 13px;
        line-height: 13px;
        padding: 10px 4px;
        font-family: monospace;
        background: #EEE;
        position: absolute;
        width: 30px;
        left: -0.5px;
        bottom: 0;
        top: 15px;
        text-align: right;
        margin-left: 5px;
        }

        .glyphicon-refresh-animate {
        -animation: spin .7s infinite linear;
        -webkit-animation: spin2 .7s infinite linear;
        }

        @-webkit-keyframes spin2 {
        from {
        -webkit-transform: rotate(0deg);
        }
        to {
        -webkit-transform: rotate(360deg);
        }
        }

        @keyframes spin {
        from {
        transform: scale(1) rotate(0deg);
        }
        to {
        transform: scale(1) rotate(360deg);
        }
        }

        #headerTitle {
        font-family: 'Antic Slab', serif;
        font-size: 100px;
        color: #DDCCEE;
        }

        .lead {
        color: #DDCCEE;
        }

        /* Custom container */
        .container-full {
        margin: 0 auto;
        width: 100%;
        min-height: 100%;
        background-color: #110022;
        color: #eee;
        overflow: hidden;
        }

        .container-full a {
        color: #efefef;
        text-decoration: none;
        }

        .v-center {
        margin-top: 7%;
        }

        #inputbox {

        /* The following three rules make a difference in the script */
        overflow: hidden;
        line-height: 18px;
        font-size: 15px;

        font-family: 'Antic Slab', serif;
        color: rgb(1, 255, 45);
        max-width: 850px;
        min-width: 850px;
        min-height: 200px;
        width: 850px;
        overflow: auto;
        background-color: black;
        }

        .input-container {
        position: relative;
        display: inline-block;
        }

        .line-nums {
        font-size: 15px;
        color: #DDCCEE;
        line-height: 18px;
        padding: 10px 4px;
        font-family: monospace;
        background-color: rgb(43, 8, 78);
        position: absolute;
        width: 29px;
        left: -36px;
        bottom: 0;
        top: 0;
        text-align: right;
        }

        .glyphicon-refresh-animate {
        -animation: spin .7s infinite linear;
        -webkit-animation: spin2 .7s infinite linear;
        }

        @-webkit-keyframes spin2 {
        from {
        -webkit-transform: rotate(0deg);
        }
        to {
        -webkit-transform: rotate(360deg);
        }
        }

        @keyframes spin {
        from {
        transform: scale(1) rotate(0deg);
        }
        to {
        transform: scale(1) rotate(360deg);
        }
        }

        .logoImg {
        height: 80px;
        position: relative;
        top: -30px;
        }

        /* layout.css Style */
        .upload-drop-zone {
        height: 200px;
        border-width: 2px;
        margin-bottom: 20px;
        }

        /* skin.css Style*/
        .upload-drop-zone {
        color: rgb(1, 255, 45);
        background-color: black;
        border-style: dashed;
        border-color: #534661;
        line-height: 200px;
        text-align: center
        }

        .upload-drop-zone.drop {
        color: rgb(1, 255, 45);
        border-color: #222;
        }

        .slider.slider-vertical {
        height: 100%;
        }

        /* slider color*/

        #GC .slider-handle {
        border-radius: 0%;
        margin-left: 0px;
        margin-top: 0px;
        width: 10px;
        }

        /* diff text */
        td.diff-line-content {
        padding-left: 20px;
        padding-right: 10px;
        vertical-align: top;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 12px;
        }

        td.diff-line-content.remove {
        background-color: #ffecec;
        }

        td.diff-line-content.add {
        background-color: #eaffea;
        }

        td.diff-line-content.empty {
        background-color: #fafafa;
        min-height: 20px;
        }

        td.diff-line-num {
        width: 6%;
        min-width: 50px;
        white-space: nowrap;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 12px;
        line-height: 18px;
        color: rgba(0, 0, 0, 0.3);
        vertical-align: top;
        text-align: right;
        border: solid #eee;
        border-width: 0 1px 0 0;
        cursor: pointer;
        border-left-width: 1px;
        padding-left: 10px;
        padding-right: 10px;
        }

        td.diff-line-num.selected {
        background-color: rgba(255, 165, 0, 0.1);
        }
        td.diff-line-num.empty.selected {
        background-color: rgba(255, 165, 0, 0.1);
        }

        td.diff-line-num:hover {
        color: rgba(0, 0, 0, 0.67);
        }

        td.diff-line-num.empty {
        background-color: #fafafa;
        height: 20px;
        }

        span.m {
        color: #a71d5d;
        display: inline-block;
        width: 50px;
        }

        table.block {
        border-color: gray;
        display: table;
        width: 100%;
        border-spacing: 2px;
        border-right: solid 1px #eee;
        }

        div.sep {
        background-color: #fafafa;
        color: rgba(0, 0, 0, 0.53);
        padding-left: 10px;
        line-height: 18px;
        font-size: 12px;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        border-right: solid 1px #eee;
        border-left: solid 3px #837979;
        }

        span.commenter {
        position: relative;
        z-index: 5;
        float: right;
        font-size: 16px;
        width: 20px;
        height: 20px;
        margin: -1px -25px -1px -10px;
        line-height: 20px;
        color: #fff;
        text-align: center;
        text-indent: 0;
        cursor: pointer;
        background-color: orange;
        border-radius: 3px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        opacity: 0;
        -webkit-transform: scale(0.8, 0.8);
        -ms-transform: scale(0.8, 0.8);
        transform: scale(0.8, 0.8);
        -webkit-transition: -webkit-transform 0.1s ease-in-out;
        transition: transform 0.1s ease-in-out;
        }

        span.commenter.selected {
        opacity: 1.0;
        transform: scale(1.0, 1.0);
        }

        div.cmbox{
        color: rgba(0, 145, 22, 1);
        padding-left: 10px;
        line-height: 18px;
        font-size: 12px;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        border-left: solid 2px rgba(0, 141, 15, 0.44);
        }

        div.cmbox>p{
        margin-bottom:0px;
        }

        tr.comrow{

        }

        span.delete{
        font-size: 13px;
        margin-left:4px;
        cursor: pointer;
        color: rgb(188, 188, 188);
        }

    </style>
</head>
<body style="height:100%">
<div style="height:100%">
    <div class="box box-info collapsed-box" id="textViewDiff" style="height:100%">
        <div class="box-body no-padding" style="height:100%">
            <div id="bheader" style="font-size:12px;height: 40px; padding-left: 20px;background-color: #f7f7f7;border: 1px solid #d8d8d8;padding:5px;border-top-left-radius: 2px;border-top-right-radius: 2px;margin-left:10px;margin-right:10px;">
                <div class="pull-right">
                    <div>
                        <input type="checkbox" id="tcloneviewScrollSyn"> Synchronize scroll bar
                    </div>
                </div>
                <span id="clone-title"></span>
            </div>
            <div id="bbody" class="row" style="padding: 0;margin-left: 10px;margin-right: 10px;height:100%">
                <div id="clone-text-left-scroller" style="overflow-y:scroll;"
                     class="col-xs-6 no-padding">
                    <div id="clone-text-left">

                    </div>
                </div>
                <div id="clone-text-right-scroller" style="overflow-y:scroll;"
                     class="col-xs-6 no-padding">
                    <div id="clone-text-right">

                    </div>
                </div>
            </div>
             <div id="clone-group-list"
             style="height:200px;overflow-y:scroll;margin-left:10px;margin-right:10px;">
            </div>
        </div>

    </div>
</div>


<!-- jQuery 2.0.2 -->
<script src="js/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<!-- DATA TABES SCRIPT -->
<script src="js/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>

<!-- Bootstrap -->
<script src="js/bootstrap.min.js" type="text/javascript"></script>

<!-- Forcegraph -->
<script src="js/d3.v3.min.js"></script>
<script src="js/dagre-d3.js"></script>
<script src="js/jquery.tipsy.js"></script>

<!-- Convex hull -->
<script src="js/graham_scan.min.js"></script>

<!-- Bootstrap slider -->
<script src="js/plugins/bootstrap-slider/bootstrap-slider2.js" type="text/javascript"></script>
<!-- Text Compare -->
<script src="resources/diff.js"></script>

<!-- Markdown -->
<script src="js/bootstrap-markdown/bootstrap-markdown.js"></script>
<script src="js/bootstrap-markdown/markdown.js"></script>
<script src="js/bootstrap-markdown/to-markdown.js"></script>

<!-- Page script -->
<script type="text/javascript">

    function resize(){
        var docHeight = $(window).height();
        var div1Height = $('#bheader').height();
        var div3Height = $('#clone-group-list').height();
        var div2Height = docHeight - div1Height - div3Height - 15;
        $('#bbody').css('height', div2Height);
        $('#clone-text-left-scroller').css('height', div2Height);
        $('#clone-text-right-scroller').css('height', div2Height);
    }

    $(document).ready(function() {
        resize();
    });

    $(window).on("resize", function () {
       resize();
    }).trigger("resize");

    var clonePartColors = d3.scale.category20c().range();


    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    var QueryString = function () {
        // This function is anonymous, is executed immediately
        var query_string = {};
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            // If first entry with this name
            if (typeof query_string[pair[0]] === "undefined") {
                query_string[pair[0]] = pair[1];
                // If second entry with this name
            } else if (typeof query_string[pair[0]] === "string") {
                var arr = [query_string[pair[0]], pair[1]];
                query_string[pair[0]] = arr;
                // If third or later entry with this name
            } else {
                query_string[pair[0]].push(pair[1]);
            }
        }
        return query_string;
    }();

    function drawBlockText(fun, $holder) {
        $holder.html('');
        for (var i = 0; i < fun.nodes.length; ++i) {
            $holder.append($('<div class="sep">').html("#" + fun.nodes[i].blockID));
            var tbl = $('<table class=\'block\' id=\'' + fun.nodes[i].blockID + '\'>');
            var tblb = tbl.append('<tbody>');
            tbl.data('block', fun.nodes[i]);
            for (var j = 0; j < fun.nodes[i].srcCodes.length; ++j) {
                var line = fun.nodes[i].srcCodes[j];
                var parts = line.split(' ');
                var $newRow = $('<tr id=\''+parts[0].trim()+'\'>');
                $newRow.append($('<td class=\'diff-line-num\'>').append(parts[0]).append($('<span class=\'commenter\'>').append('+')));
                $newRow.append($('<td class=\'diff-line-content\'>').append('&nbsp;').append(
                                $('<span class="m">').append(parts[1])
                        ).append(' ').append(
                                $('<span class="o">').append(parts.slice(2, parts.length).join(' '))
                        )
                );
                $newRow.hover(
                        function () {
                            $(this).find('span.commenter').addClass('selected');
                        }, function () {
                            $(this).find('span.commenter').removeClass('selected');
                        }
                );
                tblb.append($newRow);
            }
            $holder.append(tbl);
            tbl.data('top', tbl.position().top);
        }

    }

    function drawCommentForTable($left, $right){
        var both = [$left, $right];
        var cms = {};
        var cm_left = $left.data('comments');
        var cm_right = $right.data('comments');
        if(cm_left != null) {
            for (var i = 0; i < cm_left.length; ++i) {
                var $row = $('tr#' + cm_left[i][0]);
                var $cmr = createCommentRow(cm_left[i][1]);
                if (cms[$row.index()] == null) {
                    cms[$row.index()] = [[], []];
                }
                cms[$row.index()][0].push($cmr);
            }
        }
        if(cm_right != null) {
            for (var i = 0; i < cm_right.length; ++i) {
                var $row = $('tr#' + cm_right[i][0]);
                var $cmr = createCommentRow(cm_right[i][1]);
                if (cms[$row.index()] == null) {
                    cms[$row.index()] = [[], []];
                }
                cms[$row.index()][1].push($cmr);
            }
        }
        var offSet = 0;
        $.each(cms, function(key,val){
            var leftComp = val[1].length - val[0].length;
            var rightComp = val[0].length - val[1].length;
            var ind = parseInt(key) + offSet;
            var leftTarget = $left.find('tr:eq('+ind+')');
            var rightTarget = $right.find('tr:eq('+ind+')');
            for(var i = 0; i < leftComp; ++i){
                createEmptyRowSelected().insertAfter(leftTarget);
            }
            for(var i = 0; i < rightComp; ++i){
                createEmptyRowSelected().insertAfter(rightTarget);
            }
            for(var i = 0; i < val[0].length; ++i){
                val[0][i].insertAfter(leftTarget);
            }
            for(var i = 0; i < val[1].length; ++i){
                val[1][i].insertAfter(rightTarget);
            }
            offSet += val[1].length > val[0].length ? val[1].length : val[0].length;
        });
        alignHeight($left, $right);
    }

    function alignHeight($left, $right){
        var offset = 0; // ignoring the comment forms
        $.each($left.find('tr'), function(ind, ent){
            var $ent = $(ent);
            if($ent.hasClass('comForm')){
                offset++;
                return;
            }
            var $oent = $right.find('tr:eq('+($ent.index() - offset)+')');
            var maxHeight = $ent.height() > $oent.height() ? $ent.height() : $oent.height();
            $ent.height(maxHeight);
            $oent.height(maxHeight);
        });

    }

    function drawCloneTextList(cloneParts, holder) {
        holder.html('');
        var divlist = $('<div class=\'tree\'>');
        var ulp = $('<ul>');
        divlist.append(ulp);
        var ulc = $('<ul>');
        ulp.append(
                $('<li>').append(
                        $('<span>').append(
                                $('<i class=\'fa fa-inbox\'>')).append('  Clone Groups')
                ).append(ulc)
        );
        for (var i = 0; i < cloneParts.length; ++i) {
            var cloneSet = cloneParts[i];
            var lip = $('<li>');
            var ulip = $('<ul>');
            lip.append(
                    $('<span>').append(
                            $('<i class=\'fa fa-folder\'>')).append('  Group #' + i)
            ).append(ulip);
            for (var j = 0; j < cloneSet.length; ++j) {
                var $li = $('<li style=\'cursor:pointer;\'>').append(
                        $('<span>').append(
                                $('<i class=\'fa fa-flash\'>')).append("  block #" + cloneSet[j]._1 + " - block #" + cloneSet[j]._2)
                );
                ulip.append($li);
                $li.data('clone', cloneSet[j]);


                var block_left, block_right;


                $li.click(function () {

                    // update & compare blocks:

                    // clear previous marks
                    if (block_left != null) {
                        block_left.find('td.diff-line-num').removeClass('selected');
                        block_left.find('td.diff-line-num.empty').each(function(ind, tdc){
                            $(tdc).parent().remove();
                        });
                        block_left.find('td.diff-line-content').each(function (ind, tdc) {
                            var $tdc = $(tdc);
                            $tdc.removeClass('add').removeClass('remove');
                            var $tdchtml = $tdc.html();
                            if ($tdchtml.startsWith('+') || $tdchtml.startsWith('-')) {
                                $tdc.html($tdchtml.replace('+', '&nbsp;').replace('-', '&nbsp;'));
                            }
                        });
                    }
                    if (block_right != null) {
                        block_right.find('td.diff-line-num').removeClass('selected');
                        block_right.find('td.diff-line-num.empty').each(function(ind, tdc){
                            $(tdc).parent().remove();
                        });
                        block_right.find('td.diff-line-content').each(function (ind, tdc) {
                            var $tdc = $(tdc);
                            $tdc.removeClass('add').removeClass('remove');
                            var $tdchtml = $tdc.html();
                            if ($tdchtml.startsWith('+') || $tdchtml.startsWith('-')) {
                                $tdc.html($tdchtml.replace('+', '&nbsp;').replace('-', '&nbsp;'));
                            }
                        });
                    }


                    var clone = $(this).data('clone');
                    block_left = $('#' + clone._1);
                    block_right = $('#' + clone._2);
                    block_left.find("tr").remove();
                    block_right.find("tr").remove();

                    //scroll to block
                    var compleft = 18 - block_left.parent().find('table:first').position().top;
                    var compright = 18 - block_right.parent().find('table:first').position().top;
                    scrolling = true;
                    $('#clone-text-left-scroller').animate({scrollTop: block_left.position().top + compleft - 20}, 500);
                    $('#clone-text-right-scroller').animate({scrollTop: block_right.position().top + compright - 20}, 500);
                    scrolling = false;

                    var p_a = block_left.data('block');
                    var p_b = block_right.data('block');

                    var code_a = "", code_b = "";
                    var addr_a = [], addr_b = [];
                    var addr_ind_a = 0, addr_ind_b = 0;

                    for (var j = 0; j < p_a.srcCodes.length; ++j) {
                        var parts = p_a.srcCodes[j].split(' ');
                        addr_a.push(parts[0]);
                        code_a += p_a.srcCodes[j].replace(parts[0], "").replace(/\s{2,}/g, ' ') + "\r\n";
                    }

                    for (var j = 0; j < p_b.srcCodes.length; ++j) {
                        var parts = p_b.srcCodes[j].split(' ');
                        addr_b.push(parts[0]);
                        code_b += p_b.srcCodes[j].replace(parts[0], "").replace(/\s{2,}/g, ' ') + "\r\n";
                    }

                    var cache = [];
                    var index = -1;
                    var diff = JsDiff.diffTrimmedLines(code_a, code_b);

                    var tbl_left, tbl_right;
                    tbl_left = $('#' + clone._1 + ' > tbody:last');
                    tbl_right = $('#' + clone._2 + ' > tbody:last');

                    for (var i = 0; i < diff.length; i++) {
                        // put remove ahead e.g.
                        // rm add rm add rm add ->
                        // rm rm rm rm add add add ...
                        if (diff[i].added && diff[i + 1] && diff[i + 1].removed) {
                            var swap = diff[i];
                            diff[i] = diff[i + 1];
                            diff[i + 1] = swap;
                        }
                        var lines = diff[i].value.match(/[^\r\n]+/g);
                        if (lines == null)
                            continue;

                        for (var j = 0; j < lines.length; ++j) {
                            var line = lines[j];
                            if (diff[i].removed) {
                                var $newRowLeft = $('<tr id=\'' + addr_a[addr_ind_a]+ '\'>');
                                $newRowLeft.append($('<td class=\'diff-line-num\'>').append(addr_a[addr_ind_a]).append($('<span class=\'commenter\'>').append('+')));
                                var parts = line.split(' ');
                                $newRowLeft.append($('<td class=\'diff-line-content remove\'>').append('-').append(
                                                $('<span class="m">').append(parts[0])
                                        ).append(' ').append(
                                                $('<span class="o">').append(parts.slice(1, parts.length).join(' '))
                                        )
                                );
                                $newRowLeft.hover(
                                        function () {
                                            $(this).find('span.commenter').addClass('selected');
                                        }, function () {
                                            $(this).find('span.commenter').removeClass('selected');
                                        }
                                );
                                cache.push([$newRowLeft]);
                                addr_ind_a++;
                                if (index == -1)
                                    index = 0;
                            } else if (diff[i].added) {
                                if (index != -1 && index < cache.length) {

                                    var $newRowRight = $('<tr id=\'' + addr_b[addr_ind_b]+ '\'>');
                                    $newRowRight.append($('<td class=\'diff-line-num\'>').append(addr_b[addr_ind_b]).append($('<span class=\'commenter\'>').append('+')));
                                    var parts = line.split(' ');
                                    $newRowRight.append($('<td class=\'diff-line-content add\'>').append('+').append(
                                                    $('<span class="m">').append(parts[0])
                                            ).append(' ').append(
                                                    $('<span class="o">').append(parts.slice(1, parts.length).join(' '))
                                            )
                                    );
                                    $newRowRight.hover(
                                            function () {
                                                $(this).find('span.commenter').addClass('selected');
                                            }, function () {
                                                $(this).find('span.commenter').removeClass('selected');
                                            }
                                    );
                                    addr_ind_b++;
                                    cache[index].push($newRowRight);
                                    index++;
                                } else {
                                    if (cache.length > 0) {
                                        for (var k = 0; k < cache.length; ++k) {
                                            tbl_left.append(cache[k][0]);
                                            tbl_right.append(cache[k][1]);
                                        }
                                        cache = [];
                                        index = -1;
                                    }
                                    var $newRowRight = $('<tr id=\'' + addr_b[addr_ind_b]+ '\'>');
                                    var $newRowLeft = createEmptyRowSelected();
                                    $newRowRight.append($('<td class=\'diff-line-num\'>').append(addr_b[addr_ind_b++]).append($('<span class=\'commenter\'>').append('+')));
                                    var parts = line.split(' ');
                                    $newRowRight.append($('<td class=\'diff-line-content add\'>').append('+').append(
                                                    $('<span class="m">').append(parts[0])
                                            ).append(' ').append(
                                                    $('<span class="o">').append(parts.slice(1, parts.length).join(' '))
                                            )
                                    );
                                    $newRowLeft.hover(
                                            function () {
                                                $(this).find('span.commenter').addClass('selected');
                                            }, function () {
                                                $(this).find('span.commenter').removeClass('selected');
                                            }
                                    );
                                    tbl_left.append($newRowLeft);
                                    $newRowRight.hover(
                                            function () {
                                                $(this).find('span.commenter').addClass('selected');
                                            }, function () {
                                                $(this).find('span.commenter').removeClass('selected');
                                            }
                                    );
                                    tbl_right.append($newRowRight);
                                }
                            } else {
                                if (cache.length > 0) {
                                    for (var k = 0; k < cache.length; ++k) {
                                        if (cache[k].length == 1) {
                                            var $newRowRight = createEmptyRowSelected();
                                            cache[k].push($newRowRight);
                                        }
                                        tbl_left.append(cache[k][0]);
                                        tbl_right.append(cache[k][1]);
                                    }
                                    cache = [];
                                    index = -1;
                                }
                                var $newRowRight = $('<tr id=\'' + addr_b[addr_ind_b]+ '\'>');
                                var $newRowLeft = $('<tr id=\'' + addr_a[addr_ind_a]+ '\'>');
                                var parts = line.split(' ');
                                $newRowLeft.append($('<td class=\'diff-line-num\'>').append(addr_a[addr_ind_a++]).append($('<span class=\'commenter\'>').append('+')));
                                $newRowLeft.append($('<td class=\'diff-line-content\'>').append('&nbsp;').append(
                                                $('<span class="m">').append(parts[0])
                                        ).append(' ').append(
                                                $('<span class="o">').append(parts.slice(1, parts.length).join(' '))
                                        )
                                );
                                $newRowRight.append($('<td class=\'diff-line-num\'>').append(addr_b[addr_ind_b++]).append($('<span class=\'commenter\'>').append('+')));
                                $newRowRight.append($('<td class=\'diff-line-content\'>').append('&nbsp;').append(
                                                $('<span class="m">').append(parts[0])
                                        ).append(' ').append(
                                                $('<span class="o">').append(parts.slice(1, parts.length).join(' '))
                                        )
                                );
                                $newRowLeft.hover(
                                        function () {
                                            $(this).find('span.commenter').addClass('selected');
                                        }, function () {
                                            $(this).find('span.commenter').removeClass('selected');
                                        }
                                );
                                tbl_left.append($newRowLeft);
                                $newRowRight.hover(
                                        function () {
                                            $(this).find('span.commenter').addClass('selected');
                                        }, function () {
                                            $(this).find('span.commenter').removeClass('selected');
                                        }
                                );
                                tbl_right.append($newRowRight);

                            }
                        }
                    }// end of for each diff

                    // clear cache
                    if (cache.length > 0) {
                        for (var k = 0; k < cache.length; ++k) {
                            if (cache[k].length == 1) {
                                var $newRowRight = createEmptyRowSelected();
                                cache[k].push($newRowRight);
                            }
                            tbl_left.append(cache[k][0]);
                            tbl_right.append(cache[k][1]);
                        }
                        cache = [];
                        index = -1;
                    }

                    //line number
                    block_left.find('td.diff-line-num').addClass('selected');
                    block_right.find('td.diff-line-num').addClass('selected');

                    //comment box
                    block_left.find('span.commenter').click(function () {
                        showCommentBox(this);
                    });
                    block_right.find('span.commenter').click(function () {
                        showCommentBox(this);
                    });
                    drawCommentForTable(block_left, block_right);
                });
                //end of click
            }
            ulc.append(lip);
        }

        holder.append(divlist);


        $('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Collapse this branch');
        $('.tree li.parent_li > span').on('click', function (e) {
            var children = $(this).parent('li.parent_li').find(' > ul > li');
            if (children.is(":visible")) {
                children.hide('fast');
                $(this).attr('title', 'Expand this branch').find(' > i').addClass('icon-plus-sign').removeClass('icon-minus-sign');
            } else {
                children.show('fast');
                $(this).attr('title', 'Collapse this branch').find(' > i').addClass('icon-minus-sign').removeClass('icon-plus-sign');
            }
            e.stopPropagation();
        });
    }

    function attachComment($table, comment){
        var map = $table.data('comments');
        if(map == null){
            map = [];
            $table.data('comments',map);
        }
        map.push([comment.functionOffset, comment]);
    }

    function updateComment($table, comment){
        var map = $table.data('comments');
        if(map == null){
            return;
        }
        var indexToRemove = -1;
        $.each(map, function(ind, ent){
            if(ent[0] == comment.functionOffset){
                if(ent[1].functionId == comment.functionId &&
                        ent[1].date == comment.date) {
                    ent[1] = comment;
                }
            }
        });
    }

    function removeComment($table, comment){
        var map = $table.data('comments');
        if(map == null){
            return;
        }
        var indexToRemove = -1;
        $.each(map, function(ind, ent){
            if(ent[0] == comment.functionOffset){
                if(ent[1].functionId == comment.functionId &&
                ent[1].date == comment.date) {
                    indexToRemove = ind;
                }
            }
        });
        if(indexToRemove!=-1)
            map.splice(indexToRemove , 1);
    }

    // create comment form:
    function createForm($rowBeforeInsert, currentLine, currentFun, comObj) {
        var $form = $('<tr class=\"comForm\">').append(
                $('<td colspan=\"2\">').append(
                        $('<div>')
                                .append($('<textarea name=\"content\" data-height=\"200\" rows=\"10\">'))
                                .append($('<button class=\"btn-info btn-sm btn pull-right\" style="margin:2px">').on('click', function (event) {
                                    var cm = $form.find('textarea').val();
                                    external.PostComment(
                                        currentFun,
                                        currentLine,
                                        comObj == null ? "" : comObj.date,
                                        cm,
                                        function (dataParsed) {
                                            if (dataParsed.toString().indexOf('E:') > -1) {
                                                if (confirm('Failed to persist this comment. This function is not indexed in the database. Do you want to index it now?')) {
                                                    external.IndexFunc(currentFun, function(msg){alert(msg)});
                                                }
                                            } else {
                                                dataParsed =  $.parseJSON(dataParsed);
                                                var $row = $form.prev();
                                                $form.remove();
                                                createCommentRow(dataParsed).insertAfter($row);
                                                var tbl = $row.parent().parent();
                                                if(comObj==null)
                                                    attachComment(tbl, dataParsed);
                                                else
                                                    updateComment(tbl, dataParsed);

                                                // find prev row that has line number (not comment row)
                                                var $lineNumberRow = $row;
                                                while($lineNumberRow != null &&
                                                    $lineNumberRow.find('td.diff-line-num').length == 0){
                                                    $lineNumberRow = $lineNumberRow.prev();
                                                }
                                                if($lineNumberRow == null)
                                                    return; // should never reach here.


                                                // whether it is in the selected area
                                                if ($lineNumberRow.find('td.diff-line-num').hasClass('selected')) {
                                                    // if it is in the area for comparison
                                                    // add empty row on the other side

                                                    //if row existed then we dont need to add an empty row to the other side.
                                                    if(comObj == null) {
                                                        var containerId = $row.parent().parent().parent().attr('id');
                                                        var $opositeContainer = null;
                                                        if (containerId.indexOf('left') > 0) {
                                                            $opositeContainer = $('#clone-text-right');
                                                        } else {
                                                            $opositeContainer = $('#clone-text-left');
                                                        }
                                                        var $opositeElement = $opositeContainer.find('td.selected:eq(' + $row.index() + ')');
                                                        createEmptyRowSelected().insertAfter($opositeElement.parent());
                                                    }
                                                    $form.remove();
                                                    alignHeight($opositeElement.parent().parent().parent(), tbl);
                                                }
                                                else
                                                    $form.remove();
                                            }
                                        }
                                    );
                                }).append('submit'))
                                .append($('<button class=\"btn-danger btn-sm btn pull-right\" style="margin:2px">').on('click', function (event) {
                                    if(comObj!=null){
                                        var $row = $form.prev();
                                        createCommentRow(comObj).insertAfter($row);
                                    }
                                    $form.remove();
                                }).append('close'))
                                .append($('<span class=\"pull-left\" style="margin:2px;font-size: 12px;color: rgb(170, 170, 170);">').append('Markdown supported'))
                )
        );
        var $editArea = $form.find('textarea');
        if(comObj != null)
            $editArea.val(toMarkdown(comObj.comment));
        $editArea.markdown({autofocus: true, savable: false});
        return $form;
    }

    function createCommentRow(cm){
        var $tr = $('<tr class=\"cmrow\">').append(
                $('<td colspan=\"2\">')
                        .append($('<span class=\"pull-right delete\">')
                                .append($('<i class=\"fa fa-times-circle\">'))
                                .click(function() {
                                    var $sp = $(this);
                                    external.PostComment(
                                        cm.functionId,
                                        cm.functionOffset,
                                        cm.date,
                                        "",
                                        function (data) {
                                            if (data == null || data.toString().indexOf("E:") === 0) {
                                                alert(data);
                                                return;
                                            }

                                            var $lineNumberRow = $sp.parent().parent().prev();
                                            while($lineNumberRow != null &&
                                            $lineNumberRow.find('td.diff-line-num').length == 0){
                                                $lineNumberRow = $lineNumberRow.prev();
                                            }
                                            if($lineNumberRow == null)
                                                return; // should never reach here.

                                            if ($lineNumberRow.find('td.diff-line-num').hasClass('selected')) {
                                                var containerId = $sp.parent().parent().parent().parent().parent().attr('id');
                                                var $opositeContainer = null;
                                                if (containerId.indexOf('left') > 0) {
                                                    $opositeContainer = $('#clone-text-right');
                                                } else {
                                                    $opositeContainer = $('#clone-text-left');
                                                }
                                                var $opositeElement = $opositeContainer.find('td.selected:eq(' + $sp.parent().parent().index() + ')');
                                                $opositeElement.parent().remove();
                                            }
                                            removeComment($sp.parent().parent().parent().parent(), cm);
                                            $sp.parent().parent().remove();
                                        },
                                        "drop"
                                    );
                                })
                )
                        .append($('<span class=\"pull-right delete\">')
                                .append($('<i class=\"fa fa-edit\">'))
                                .click(function() {
                                    var $crow = $(this).parent().parent();
                                    var $lineNumberRow = $crow;
                                    while($lineNumberRow != null &&
                                    $lineNumberRow.find('td.diff-line-num').length == 0){
                                        $lineNumberRow = $lineNumberRow.prev();
                                    }
                                    if($lineNumberRow == null)
                                        return; // should never reach here.

                                    var currentLine = $lineNumberRow.attr('id');
                                    var currentFun = $crow.parent().parent().data('block').functionIdStr;
                                    createForm($crow.prev(),
                                            currentLine,
                                            currentFun,
                                            cm
                                    ).insertAfter($crow.prev());
                                    $crow.remove();
                                })
                )
                        .append($('<div class=\'cmbox\'>')
                                .append(markdown.toHTML( cm.comment ))
                )
        );
        return $tr;
    }

    function createEmptyRow(){
        var $erow = $('<tr>');
        $erow.append($('<td class=\'diff-line-num empty\'>'));
        $erow.append($('<td class=\'diff-line-content empty\'>'));
        return $erow;
    }

    function createEmptyRowSelected(){
        var $erow = $('<tr>');
        $erow.append($('<td class=\'diff-line-num empty selected\'>'));
        $erow.append($('<td class=\'diff-line-content empty\'>'));
        return $erow;
    }

    function showCommentBox(tspan) {
        var $tspan = $(tspan);
        var row = $tspan.parent().parent();
        if(row!=null && row.next() != null && row.next().hasClass('comForm')){
            row.next().remove();

        }else{
            var currentLine = $(tspan).parent().text().replace('+', ' ');
            var currentFun = $(tspan).parent().parent().parent().parent().data('block').functionIdStr;
            createForm($tspan.parent().parent(),currentLine,currentFun).insertAfter(row);

        }
    }

    function plotComments(fun, $holder){
        external.GetComments(
            fun.functionIdStr,
            function (data) {
                data =  $.parseJSON(data);
                $.each(data, function(ind,ent){
                    var $row = $holder.find('tr#'+ent.functionOffset);
                    var $cmbox = createCommentRow(ent);
                    $cmbox.insertAfter($row);

                    var $tbl = $row.parent().parent();
                    attachComment($tbl, ent);
                });
            }
        )
    }

    var $divs = $('#clone-text-left-scroller, #clone-text-right-scroller');
    var scrolling = false;
    var diff = 0;
    var sync = function(e){
        if(! $('#tcloneviewScrollSyn').is(':checked') || scrolling){
            diff =  $('#clone-text-left-scroller').scrollTop() - $('#clone-text-right-scroller').scrollTop();
            return;
        }
        scrolling = true;
        var $other = $divs.not(this), other = $other.get(0);
        var dist = this.scrollTop;
        console.log(dist);
        if($(this).index()  == 0)
            other.scrollTop = dist - diff;
        else
            other.scrollTop = dist + diff;
        scrolling = false;
        diff =  $('#clone-text-left-scroller').scrollTop() - $('#clone-text-right-scroller').scrollTop();
    }
    $divs.on( 'scroll', sync);



    function drawCloneTextDiff(p_a, p_b, cloneParts) {
        $('#clone-title').html(
                p_a.functionName + "(#" + p_a.functionId + ")@" + p_a.binaryName + "(#" + p_a.binaryId + ")           compares to            " +
                p_b.functionName + "(#" + p_b.functionId + ")@" + p_b.binaryName + "(#" + p_b.binaryId + ")"
        );

        drawBlockText(p_a, $('#clone-text-left'));
        drawBlockText(p_b, $('#clone-text-right'));
        drawCloneTextList(cloneParts, $('#clone-group-list'));

        plotComments(p_a, $('#clone-text-left'));
        plotComments(p_b, $('#clone-text-right'));
        // div->ul
        //      ->li (span (i, title), ul);

        $('span.commenter').click(function () {
            showCommentBox(this);
        });

    }



    var pb_fun;
    var pa_fun;
    function callBack(funcb){
        pb_fun = $.parseJSON(funcb);
        drawCloneTextDiff(pa_fun, pb_fun, cp);
    }



     var gd;
     var cp;
     window.onload = function(){
        //var dataParsed = $.parseJSON(window.params);
        //CreateCloneGraph(dataParsed);
        // alert(window.GData);
        //alert(window.params);

        if (typeof String.prototype.startsWith != 'function') {
            // see below for better implementation!
            String.prototype.startsWith = function (str){
                return this.indexOf(str) === 0;
            };
        }

        gd =  $.parseJSON(window.GData);

        p_a = window.params[0];
        p_b = window.params[1];
        var p_b_param = gd.results[p_a].clones[p_b].functionIdStr;
        pa_fun = gd.results[p_a].function;
        cp = gd.results[p_a].clones[p_b].clonedParts
        external.GetFunc(p_b_param, callBack);

     }







</script>
</body>
</html> 