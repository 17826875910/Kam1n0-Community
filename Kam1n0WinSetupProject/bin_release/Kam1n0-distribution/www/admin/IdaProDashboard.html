<!--
//******************************************************************************
// Copyright 2015 McGill University									
//																					
// Licensed under the Creative Commons CC BY-NC-ND 3.0 (the "License");				
// you may not use this file except in compliance with the License.				
// You may obtain a copy of the License at										
//																				
//    https://creativecommons.org/licenses/by-nc-nd/3.0/								
//																				
// Unless required by applicable law or agreed to in writing, software			
// distributed under the License is distributed on an "AS IS" BASIS,			
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.		
// See the License for the specific language governing permissions and			
// limitations under the License.												
//******************************************************************************//
-->

<!DOCTYPE html>
<html style="overflow-y: scroll;">
    <head>
        <meta charset="UTF-8">
        <title>DMaS-McGill | Kam1n0 </title>
        <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
        <!-- bootstrap 3.0.2 -->
        <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <!-- font Awesome -->
        <link href="../css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <!-- Ionicons -->
        <link href="../css/ionicons.min.css" rel="stylesheet" type="text/css" />
        <!-- Theme style -->
        <link href="../css/AdminLTE.css" rel="stylesheet" type="text/css" />
		<!-- Forcegraph style -->
        <link href="../css/forcegraph.css" rel="stylesheet" type="text/css" />

        <!-- Morris chart -->
        <link href="../css/morris/morris.css" rel="stylesheet" type="text/css" />
        <!-- jvectormap -->
        <link href="../css/jvectormap/jquery-jvectormap-1.2.2.css" rel="stylesheet" type="text/css" />

		<!-- Forcegraph style -->
        <link href="../css/forcegraph.css" rel="stylesheet" type="text/css" />
		<!-- Data table -->
		<link href="../css/datatables/jquery.dataTables.css" rel="stylesheet" type="text/css" />
		
		<link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon" />
		
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
          <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
		<style>
        /* layout.css Style */
        .upload-drop-zone {
            height: 200px;
            border-width: 2px;
            margin-bottom: 20px;
        }

        /* skin.css Style*/
        .upload-drop-zone {
            color: #ccc;
            border-style: dashed;
            border-color: #ccc;
            line-height: 200px;
            text-align: center
        }
        .upload-drop-zone.drop {
            color: #222;
            border-color: #222;
        }

        .loading-img {
            display: none;
        }

        .overlay {
            display: none;
        }


		</style>
    </head>
    <body class="skin-black">
        
        <div class="wrapper row-offcanvas row-offcanvas-left">
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="left-side sidebar-offcanvas collapse-left">
                <!-- sidebar: style can be found in sidebar.less -->
                <section class="sidebar">
                    
                </section>
                <!-- /.sidebar -->
            </aside>

			<!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side strech">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        Administration Dashboard
                        <small>Control panel</small>
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                        <li class="active"> Administration Dashboard</li>
                    </ol>
                </section>

                <!-- Main content -->
                <section class="content">

                    <!-- Small boxes (Stat box) -->
                    <div class="row">
                        <div class="col-lg-3 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-navy">
                                <div class="inner">
                                    <h3 id="indexedBinFunH" >
                                        0/0
                                    </h3>
                                    <p>
                                        Indexed binaries/functions
                                    </p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars" style="color:white"></i>
                                </div>
                                <a href="#" class="small-box-footer">
                                    More info <i class="fa fa-arrow-circle-right"></i>
                                </a>
                            </div>
                        </div><!-- ./col -->
                        <div class="col-lg-3 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-navy">
                                <div class="inner">
                                    <h3 id="indexedBloH">
                                        0
                                    </h3>
                                    <p>
                                        Indexed blocks
                                    </p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars" style="color:white"></i>
                                </div>
                                <a href="#" class="small-box-footer">
                                    More info <i class="fa fa-arrow-circle-right"></i>
                                </a>
                            </div>
                        </div><!-- ./col -->
                        <div class="col-lg-3 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-navy">
                                <div class="inner">
                                    <h3 id="userH">
                                        0
                                    </h3>
                                    <p>
                                        User Registrations
                                    </p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-person-add" style="color:white"></i>
                                </div>
                                <a href="#" class="small-box-footer">
                                    More info <i class="fa fa-arrow-circle-right"></i>
                                </a>
                            </div>
                        </div><!-- ./col -->
                        <div class="col-lg-3 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-navy">
                                <div class="inner">
                                    <h3>
                                        0
                                    </h3>
                                    <p>
                                        Function search
                                    </p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-pie-graph" style="color:white"></i>
                                </div>
                                <a href="#" class="small-box-footer">
                                    More info <i class="fa fa-arrow-circle-right"></i>
                                </a>
                            </div>
                        </div><!-- ./col -->
                    </div><!-- /.row -->

                    <!-- top row -->
                    <div class="row">
                        <div class="col-xs-12 connectedSortable">
                            
                        </div><!-- /.col -->
                    </div>
                    <!-- /.row -->

                    <!-- Main row -->
                    <div class="row">
                        <!-- Left col -->
                        <section class="col-lg-6 connectedSortable"> 
                            <!-- Box (with bar chart) -->
                            <div class="box box-info" id="loading-example">
                                <div class="box-header">
                                    <!-- tools box -->
                                    <div class="pull-right box-tools">
                                        Real time
                                        <div class="btn-group" id="realtime" data-toggle="btn-toggle">
                                            <button type="button" class="btn btn-default btn-xs active" data-toggle="on">On</button>
                                            <button type="button" class="btn btn-default btn-xs" data-toggle="off">Off</button>
                                        </div>
                                        <button class="btn btn-primary btn-sm" data-widget='collapse' data-toggle="tooltip" title="Collapse"><i class="fa fa-minus"></i></button>
                                    </div><!-- /. tools -->
                                    <i class="fa fa-tachometer"></i>

                                    <h3 class="box-title">Server Load/Memory</h3>
                                </div><!-- /.box-header -->
                                <div class="box-body no-padding">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <!--cpu chart-->
                                            <div class="chart" id="cpuchart" style="height: 250px;"></div>
                                        </div>
                                        <div class="col-sm-6">
                                            <!-- memory chart-->
                                            <div id="memchart" style="height: 250px;"></div>
                                        </div><!-- /.col -->
                                    </div><!-- /.row - inside box -->
                                </div><!-- /.box-body -->
                                <div class="box-footer">

                                    <span class="pull-left" style="margin-bottom: 10px" id="storageSpan">Storage:</span>
                                     <div class="progress sm progress-striped active" style="width: 100%" >
                                           <div class="progress-bar progress-bar-aqua" id="storageUsage" style="width: 10%;"></div>
                                     </div>

                                </div><!-- /.box-footer -->
                            </div><!-- /.box -->        

                            <div class="box box-info" id="binaryBox">
                                <div class="box-header">
                                    <i class="fa fa-cloud-upload"></i>
                                    <h3 class="box-title">Index a binary file</h3>
                                    <!-- tools box -->
                                    <div class="pull-right box-tools">
                                        <button id="binaryBoxRefresh" class="btn btn-primary btn-sm" data-toggle="tooltip" title="Reload"><i class="fa fa-refresh"></i></button>
                                        <button class="btn btn-primary btn-sm" data-widget='collapse' data-toggle="tooltip" title="Collapse"><i class="fa fa-minus"></i></button>
                                    </div><!-- /. tools -->
                                </div>
                                <div class="box-body">
                                    <div >
                                        <div class="panel panel-default">
                                            <div class="panel-heading"><strong>Upload File</strong> <small>file upload to index</small></div>
                                            <div class="panel-body">

                                                <form class="form-horizontal" id="binaryUploadForm" enctype="multipart/form-data">
                                                    <fieldset>

                                                        <!-- Form Name -->
                                                        <legend>Select a binary file from your computer</legend>

                                                        <!-- Text input-->
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label" for="newName">Re-name</label>
                                                            <div class="col-md-8">
                                                                <input id="newName" name="newName" type="text" placeholder="the name of the binary" class="form-control ">
                                                                <p class="help-block">Optional. Just for rename.</p>
                                                            </div>
                                                        </div>

                                                        <!-- File Button -->
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label" for="file">Pick a binary file</label>
                                                            <div class="col-lg-8">
                                                                <input class="pull-left" name="file" type="file" id="file" required="">
                                                                <span class="pull-right" id="fileSizeSpan"></span>
                                                            </div>
                                                        </div>

                                                        <!-- File Button -->
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label" ></label>
                                                            <div class="col-lg-8">
                                                                <div class="upload-drop-zone" id="drop-zone">
                                                                    Or drag and drop a binary file here
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Button -->
                                                        <div class="form-group">
                                                            <label class="col-md-2 control-label" for="uploadFileBut"></label>
                                                            <div class="col-lg-6">
                                                                <button id="uploadFileBut" name="uploadFileBut" class="btn btn-default">Submit</button>
                                                            </div>
                                                        </div>

                                                    </fieldset>
                                                </form>


                                                <legend>Indexing Progress</legend>
                                                <span>(note: each account can have only one indexing job running.)</span>
                                                <div id="binaryProgressPanel">

                                                </div>
                                            </div>
                                        </div>

                                            <div class="panel panel-default">
                                                <div class="panel-heading"><strong>Indexed binaries</strong></div>
                                                <div class="panel-body">
                                                    <table id="binaryTable" style="width:100%"
                                                           class="table  dataTable">
                                                        <thead>
                                                        <tr>
                                                            <th>Binary Name</th>
                                                            <th>Number of functions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody id="binaryList">
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div>

                                            </div>

                                    </div> <!-- /container -->
                                </div>
                                <div class="box-footer clearfix">
                                    <div class="progress sm progress-striped" id="dropBinaryProgress">
                                        <div class="progress-bar progress-bar-aqua" style="width: 0%;"></div>
                                    </div>
                                    <button id="dropSeletectedBinaryBut" class="btn btn-default pull-right">Delete selected binaries</button>
                                </div>
                                <div class="overlay"></div>
                                <div class="loading-img"></div>
                            </div>
                        </section><!-- /.Left col -->

                        <!-- right col (We are only adding the ID to make the widgets sortable)-->
                        <section class="col-lg-6 connectedSortable">
                            

                            <!-- Running jobs box -->
                            <div class="box box-info" id="jobBox">
                                <div class="box-header">
                                    <!-- tools box -->
                                    <div class="pull-right box-tools">
                                        <button id="jobBoxRefresh" class="btn btn-primary btn-sm" data-toggle="tooltip" title="Reload"><i class="fa fa-refresh"></i></button>
                                        <button class="btn btn-primary btn-sm pull-right" data-widget='collapse' data-toggle="tooltip" title="Collapse" style="margin-right: 5px;"><i class="fa fa-minus"></i></button>
                                    </div><!-- /. tools -->

                                    <i class="fa fa-coffee"></i>
                                    <h3 class="box-title">
                                        jobs
                                    </h3>
                                </div>
                                <div class="box-body">
                                    <div>
                                        <div class="panel panel-default">
                                            <div class="panel-heading"><strong>Running jobs</strong></div>
                                            <div class="panel-body">
                                                <table id="jobTable" style="width:100%"
                                                       class="table  dataTable">
                                                    <thead>
                                                    <tr>
                                                        <th>User</th>
                                                        <th>Job name</th>
                                                        <th>Current state</th>
                                                        <th>Current progress (%)</th>
                                                        <th>Running time (s)</th>
                                                        <th>Starting time</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="jobList">
                                                    </tbody>
                                                </table>


                                            </div>
                                        </div>
                                        <div class="panel panel-default">
                                            <div class="panel-heading"><strong>Historical jobs</strong></div>
                                            <div class="panel-body">
                                                <table id="jobHistoryTable" style="width:100%"
                                                       class="table  dataTable">
                                                    <thead>
                                                    <tr>
                                                        <th>User</th>
                                                        <th>Job name</th>
                                                        <th>Current state</th>
                                                        <th>Current progress</th>
                                                        <th>Running time</th>
                                                        <th>Starting time</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="jobHistoryList">
                                                    </tbody>
                                                </table>


                                            </div>
                                        </div>
                                    </div>

                                </div><!-- /.box-body-->
                                <div class="box-footer">

                                </div>
                                <div class="overlay"></div>
                                <div class="loading-img"></div>
                            </div>
                            <!-- /.box -->

                            <!-- List box -->
                            <div class="box box-info" id="userBox">
                                <div class="box-header">
                                    <!-- tools box -->
                                    <div class="pull-right box-tools">
                                        <button id="userBoxRefresh" class="btn btn-primary btn-sm" data-toggle="tooltip" title="Reload"><i class="fa fa-refresh"></i></button>
                                        <button class="btn btn-primary btn-sm pull-right" data-widget='collapse' data-toggle="tooltip" title="Collapse" style="margin-right: 5px;"><i class="fa fa-minus"></i></button>
                                    </div><!-- /. tools -->

                                    <i class="fa fa-users"></i>
                                    <h3 class="box-title">
                                        Registered users
                                    </h3>
                                </div>
                                <div class="box-body">
                                    <div>
                                        <div class="panel panel-default">
                                            <div class="panel-heading"><strong>Add new user</strong></div>
                                            <div class="panel-body">

                                                <!-- Standard Form -->
                                                <form class="form-horizontal" id="addUserForm">
                                                    <fieldset>

                                                        <!-- Form Name -->
                                                        <legend>Add/Update an user</legend>

                                                        <!-- Text input-->
                                                        <div class="form-group required-control">
                                                            <label class="col-md-3 control-label" for="uid">User email</label>
                                                            <div class="col-md-8">
                                                                <input id="uid" name="uid" type="text" placeholder="the user's email will be used to login" class="form-control " required="">

                                                            </div>
                                                        </div>

                                                        <!-- Password input-->
                                                        <div class="form-group required-control">
                                                            <label class="col-md-3 control-label" for="upw">User password</label>
                                                            <div class="col-md-8">
                                                                <input id="upw" name="upw" type="password" placeholder="the password used to login" class="form-control " required="">

                                                            </div>
                                                        </div>

                                                        <!-- Select Multiple -->
                                                        <div class="form-group">
                                                            <label class="col-md-3 control-label" for="ur">User roles</label>
                                                            <div class="col-md-8">
                                                                <select id="ur" name="ur" class="form-control " multiple="multiple" required="">
                                                                    <option>admin</option>
                                                                    <option>user</option>
                                                                </select>
                                                            </div>
                                                        </div>

                                                        <!-- Button -->
                                                        <div class="form-group">
                                                            <div class="col-lg-6">
                                                                <button id="addUserBut" name="addUserBut" class="btn btn-default" type="submit">Submit</button>
                                                                <button id="dropUserBut" name="addUserBut" class="btn btn-default" type="button">Delete</button>
                                                            </div>
                                                        </div>

                                                    </fieldset>
                                                </form>

                                            </div>
                                        </div>

                                        <div class="panel panel-default">
                                                <div class="panel-heading"><strong>List of all users</strong></div>
                                                <div class="panel-body">
                                                    <table id="userTable" style="width:100%"
                                                           class="table  dataTable">
                                                        <thead>
                                                        <tr>
                                                            <th>User ID</th>
                                                            <th>Credential (encrypted)</th>
                                                            <th>Roles</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody id="userList">
                                                        </tbody>
                                                    </table>
                                                </div>
                                        </div>

                                    </div>

                                </div><!-- /.box-body-->
                                <div class="box-footer">

                                </div>
                                <div class="overlay"></div>
                                <div class="loading-img"></div>
                            </div>
                            <!-- /.box -->



                        </section><!-- right col -->
                    </div><!-- /.row (main row) -->

                </section><!-- /.content -->
            </aside><!-- /.right-side -->
			
        </div><!-- ./wrapper -->



        <!-- jQuery 2.0.2 -->
        <script src="../js/jquery.min.js"></script>
        <!-- jQuery UI 1.10.3 -->
        <script src="../js/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <!-- Bootstrap -->
        <script src="../js/bootstrap.min.js" type="text/javascript"></script>
        <!-- FLOT CHARTS -->
        <script src="../js/plugins/flot/jquery.flot.min.js" type="text/javascript"></script>
        <script language="javascript" type="text/javascript" src="../js/jquery.flot.resize.js"></script>
        <!-- Sparkline -->
        <script src="../js/plugins/sparkline/jquery.sparkline.min.js" type="text/javascript"></script>
        <!-- jvectormap -->
        <script src="../js/plugins/jvectormap/jquery-jvectormap-1.2.2.min.js" type="text/javascript"></script>
        <script src="../js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js" type="text/javascript"></script>
        <!-- fullCalendar -->
        <script src="../js/plugins/fullcalendar/fullcalendar.min.js" type="text/javascript"></script>
        <!-- jQuery Knob Chart -->
        <script src="../js/plugins/jqueryKnob/jquery.knob.js" type="text/javascript"></script>
        <!-- daterangepicker -->
        <script src="../js/plugins/daterangepicker/daterangepicker.js" type="text/javascript"></script>
        <!-- Bootstrap WYSIHTML5 -->
        <script src="../js/plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js" type="text/javascript"></script>
        <!-- iCheck -->
        <script src="../js/plugins/iCheck/icheck.min.js" type="text/javascript"></script>


		<!-- DATA TABES SCRIPT -->
        <script src="../js/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>

        <!-- AdminLTE App -->
        <script src="../js/AdminLTE/app.js" type="text/javascript"></script>

        <!-- Page script -->
        <script type="text/javascript">

            function getCookie(cname) {
                var name = cname + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') c = c.substring(1);
                    if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
                }
                return "";
            }



            /* jQueryKnob */
            $(".knob").knob();


            var jobTable;
            var userTable;
            var binaryTable;

            // datatable:
            $(document).ready(function () {

                jobTable = $('#jobTable').DataTable({
                    "bPaginate": false,
                    "bLengthChange": false,
                    "bFilter": false,
                    "bSort": true,
                    "bInfo": true,
                    "bAutoWidth": false
                });

                userTable = $('#userTable').DataTable({
                    "bPaginate": false,
                    "bLengthChange": false,
                    "bFilter": false,
                    "bSort": true,
                    "bInfo": true,
                    "bAutoWidth": false
                });

                binaryTable =$('#binaryTable').DataTable({
                    "bPaginate": false,
                    "bLengthChange": false,
                    "bFilter": false,
                    "bSort": true,
                    "bInfo": true,
                    "bAutoWidth": false
                });




                $('#jobBoxRefresh').click(function(){
                    var m1 = $('#jobBox').find('.overlay')
                    var m2 = $('#jobBox').find('.loading-img')
                    m1.css('display', 'initial');
                    m2.css('display', 'initial');
                    $.get( "JobList", function( data ) {
                        var jobs = JSON.parse(data);
                        jobTable.row().remove();
                        for(var ind in jobs){
                            var job = jobs[ind];
                            jobTable.row.add([
                                job.userKey,
                                job.taskName,
                                job.progress.message,
                                (job.progress.currentProgress * 100).toFixed(2),
                                (job.runtime / 1000).toFixed(3),
                                job.startingTime
                            ]);
                        }
                        jobTable.draw();
                        m1.css('display', 'none');
                        m2.css('display', 'none');
                    });
                });


                $('#userBoxRefresh').click(function(){
                    var m1 = $('#userBox').find('.overlay')
                    var m2 = $('#userBox').find('.loading-img')
                    m1.css('display', 'initial');
                    m2.css('display', 'initial');
                    $.get( "UserList", function( data ) {
                        var users = JSON.parse(data);
                        userTable.row().remove();
                        for(var ind in users){
                            var user = users[ind];
                            userTable.row.add([
                                user.key,
                                user.credent,
                                user.roles
                            ]);
                        }
                        userTable.draw();
                        m1.css('display', 'none');
                        m2.css('display', 'none');
                    });
                });


                $('#userBox tbody').on( 'click', 'tr', function () {
                    userTable.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                    var dat = userTable.row(this).data();
                    if(dat.length < 3)
                        return;
                    $('#uid').val(dat[0]);
                    $('#upw').val(dat[1]);
                    $('#ur option:selected').prop("selected", false);
                    $.each(dat[2], function(i,e){
                        $("#ur option:contains('" + e + "')").prop("selected", true);
                    });
                });


                $('#binaryBoxRefresh').click(function(){
                    var m1 = $('#binaryBox').find('.overlay')
                    var m2 = $('#binaryBox').find('.loading-img')
                    m1.css('display', 'initial');
                    m2.css('display', 'initial');
                    $.get( "BinaryList", function( data ) {
                        var binaries = JSON.parse(data);
                        binaryTable.row().remove();
                        for(var ind in binaries){
                            var binary = binaries[ind];
                            binaryTable.row.add([
                               binary.name,
                               binary.numOfFunctions
                            ]);
                        }
                        binaryTable.draw();
                        m1.css('display', 'none');
                        m2.css('display', 'none');
                    });
                });

                $('#binaryBox tbody').on( 'click', 'tr', function () {
                    if ( $(this).hasClass('selected') ) {
                        $(this).removeClass('selected');
                    }else{
                        $(this).addClass('selected');
                    }
                });

                $('#dropSeletectedBinaryBut').click( function() {
                    $('#dropSeletectedBinaryBut').prop('disabled', true);
                    $('#dropBinaryProgress').addClass('active');
                    var ids = [];
                    binaryTable.$('tr.selected').each(function(i,e){
                        ids = ids.concat(binaryTable.row(this).data()[0])
                    });
                    var i = 0;
                    function complete(){
                        $('#dropSeletectedBinaryBut').prop('disabled', false);
                        $('#dropBinaryProgress').removeClass('active');
                        $('#binaryBoxRefresh').click();
                        updateHeaderStat();
                    }
                    function nextCall() {
                        if(i == ids.length){
                            complete();
                            return;
                        } //last call was last item in the array
                        $.ajax({
                            url: 'BinaryDrop',
                            type: 'post',
                            data: { bid: ids[i++] },
                            success: function(data){
                                if(data.indexOf('E:') > -1){
                                    alert(data);
                                    complete();
                                    return;
                                }
                                var percent = Math.round(i * 100.0 / ids.length) + '%';
                                $('#dropBinaryProgress').find('div').css({width:percent});
                                nextCall();
                            }
                        });
                    }
                    nextCall();
                    return false;
                });




                $('#addUserForm').submit( function() {
                    $.ajax({
                        url: 'UserAddOrUpdate',
                        type: 'post',
                        data: $('#addUserForm').serialize(),
                        success: function(data) {
                            if(data.indexOf('E:') > -1)
                                alert(data);
                            $('#userBoxRefresh').click();
                            updateHeaderStat();
                        }
                    });
                    return false;
                });


                $('#dropUserBut').click( function() {
                    $.ajax({
                        url: 'UserDrop',
                        type: 'post',
                        data: $('#addUserForm').serialize(),
                        success: function(data) {
                            if(data.indexOf('E:') > -1)
                                alert(data);
                            $('#userBoxRefresh').click();
                            updateHeaderStat();
                        }
                    });
                    return false;
                });


                // drag drop in form
                var dropZone = document.getElementById('drop-zone');
                var uploadForm = document.getElementById('binaryUploadForm');

                var currentState = -1;
                var currentProgressBar = null;
                var jid;
                var numOfQueries = 0; //track how many times the cline has queried the services.
                function queryBinaryIndexJob(callback){
                    $.ajax({
                        type: "GET",
                        url: '/local',
                        data:{
                            id:jid
                        },
                        success: function(snyData) {
//                            if(snyData.indexOf('E:') > -1){
//                                alert(snyData);
//                                return null;
//                            }
                            numOfQueries++;

                            var progress = snyData;

                            // update progress ui
                            if(progress.currentState != currentState){
                                currentState = progress.currentState;
                                if(currentProgressBar != null){
                                    currentProgressBar.removeClass('active');
                                    currentProgressBar.find('div').css({width: "100%"});
                                }
                                currentProgressBar = createProgressBar(progress.message);
                            }
                            var percent = Math.round(progress.currentProgress * 100)+'%';
                            currentProgressBar.find('div').css({width: percent});
                            currentProgressBar.find('span').html(percent);

                            if(progress.complete == true){
                                //do something
                                if(currentProgressBar != null){
                                    currentProgressBar.removeClass('active');
                                    currentProgressBar.find('div').css({width: "100%"});
                                }
                                currentState = -1;
                                currentProgressBar = null;
                                callback(progress);
                                return progress;
                            }else{
                                setTimeout(function(){queryBinaryIndexJob(callback);}, 1000);
                            }

                        }
                    });
                }

                function createProgressBar(msg){
                    var $div = $("<div>", {});
                    var $span1 = $("<span>", {}).html('Status: ');
                    var $span2 = $("<span>", {}).html(msg);
                    $div.append($span1);
                    $div.append($span2);
                    var panel = $('#binaryProgressPanel');
                    panel.append($div);
                    $div = $("<div>", {'class':'progress progress-striped active'});
                    panel.append($div);
                    var $divp = $("<div>", {'class':'progress-bar progress-bar-aqua'});
                    $divp.css({width: "0%"});
                    $div.append($divp);
                    $div.append($("<span>", {}).html('0%'));
                    return $div;
                }

                uploadForm.addEventListener('submit', function(e) {

                    var files = document.getElementById('file').files;
                    console.log(files[0]);
                    e.preventDefault();

                    var formData = new FormData($(this)[0]);

                    $.ajax({
                        url: 'BinaryIndex',
                        type: 'post',
                        data: formData,
                        contentType: false,
                        processData: false,
                        cache:false,
                        success: function(data) {
                            if(data.indexOf('E:') > -1){
                                alert(data);
                            }else{
                                jid = data;
                                currentState = -1;
                                currentProgressBar = null;
                                numOfQueries = 0;
                                $('#binaryProgressPanel').empty();
                                var progress = queryBinaryIndexJob(function(progress){
                                    $('#binaryBoxRefresh').click();
                                    updateHeaderStat();
                                });

                            }
                        },
                        statusCode:{
                            500:function(){alert("The input file exceeds the maximum file size (1MB).")}
                        }
                    });
                    return false;
                })

                $.ajax({
                    url: '/JobID',
                    type: 'GET',
                    data:{
                        task:'IndexBinary'
                    },
                    success: function(data) {
                        if(data!=null && data.length != 0){
                        if(data.indexOf('E:') > -1){
                            alert(data);
                        }else{
                            jid = data;
                            currentState = -1;
                            currentProgressBar = null;
                            numOfQueries = 0;
                            $('#binaryProgressPanel').empty();
                            var progress = queryBinaryIndexJob(function(progress){
                                if(numOfQueries > 1){
                                    //$('html,body, #myModal').animate({scrollTop:$('#binaryProgressPanel').offset().top}, 1000);
                                    $('#binaryBoxRefresh').click();
                                    updateHeaderStat();
                                }
                            });

                        }}
                    }
                });



                dropZone.ondrop = function(e) {
                    e.preventDefault();
                    this.className = 'upload-drop-zone';
                    var files = e.dataTransfer.files;
                    document.getElementById('file').files = files;
                    $('#fileSizeSpan').text('size:' + Math.round(files[0].size/1024) + " kb");
                }

                $('#file').change(function(e){
                    $('#fileSizeSpan').text('size:' +  Math.round(document.getElementById('file').files[0].size/1024) + " kb");
                });

                dropZone.ondragover = function() {
                    this.className = 'upload-drop-zone drop';
                    return false;
                }

                dropZone.ondragleave = function() {
                    this.className = 'upload-drop-zone';
                    return false;
                }



                /*
                 * Flot Interactive Chart
                 * -----------------------
                 */
                // We use an inline data source in the example, usually data would
                // be fetched from a server
                var dataCpu1 = [], dataCpu2 = [];
                var dataMem1 = [], dataMem2 = [], dataMem3 = [];
                var totalPoints = 200, counter = 0;
                for(var i = 0; i < totalPoints; ++i){
                    dataCpu1.push(0);
                    dataCpu2.push(0);
                    dataMem1.push(0);
                    dataMem2.push(0);
                    dataMem3.push(0);
                }
                function pad(arr) {
                    // Zip the generated y values with the x values
                    var res = [];
                    for (var i = 0; i < arr.length; ++i) {
                        res.push([i, arr[i]]);
                    }

                    return res;
                }

                var cpu_plot = $.plot("#cpuchart", [pad(dataCpu1),pad(dataCpu2)], {
                    grid: {
                        borderColor: "#f3f3f3",
                        borderWidth: 1,
                        tickColor: "#f3f3f3"
                    },
                    series: {
                        shadowSize: 0 // Drawing is faster without shadows
                    },
                    lines: {
                        fill: true //Converts the line chart to area chart
                    },
                    yaxis: {
                        min: 0,
                        show: true
                    },
                    xaxis: {
                        show: true
                    },
                    colors: ["#39cccc", "#FF9933" ]
                });

                var mem_plot = $.plot("#memchart", [pad(dataMem1),pad(dataMem2),pad(dataMem3)], {
                    grid: {
                        borderColor: "#f3f3f3",
                        borderWidth: 1,
                        tickColor: "#f3f3f3"
                    },
                    series: {
                        shadowSize: 0 // Drawing is faster without shadows
                    },
                    lines: {
                        fill: true //Converts the line chart to area chart
                    },
                    yaxis: {
                        min: 0,
                        show: true
                    },
                    xaxis: {
                        show: true
                    },
                    colors: ["#39cccc", "#FF9933","#3c8dbc"]
                });

                var updateInterval = 1000; //Fetch data ever x milliseconds
                var realtime = "on"; //If == to on then fetch data every x seconds. else stop fetching
                function update() {
                    $.ajax({
                        url: 'InfoSystem',
                        type: 'get',
                        success: function(data) {
                            if(data.indexOf('E:') > -1){
                                alert(data);
                                return;
                            }else{
                                var info = JSON.parse(data);

                                dataCpu1 = dataCpu1.slice(1);
                                dataCpu1.push(info.cpu[0]);
                                dataCpu2 = dataCpu2.slice(1);
                                dataCpu2.push(info.cpu[1]);

                                dataMem1 = dataMem1.slice(1);
                                dataMem1.push(info.memory[0]);
                                dataMem2 = dataMem2.slice(1);
                                dataMem2.push(info.memory[1]);
                                dataMem3 = dataMem3.slice(1);
                                dataMem3.push(info.memory[2]);

                                cpu_plot.setData([pad(dataCpu1),pad(dataCpu2)]);
                                cpu_plot.draw();
                                cpu_plot.setupGrid();

                                mem_plot.setData([pad(dataMem1),pad(dataMem2),pad(dataMem3)]);
                                mem_plot.draw();
                                mem_plot.setupGrid();

                                var storagePercent = Math.round((info.ldb[0] - info.ldb[1]) * 100/ info.ldb[0]) + '%';
                                var storageText = 'storage: ' + (info.ldb[0] - info.ldb[1]) + '/' + info.ldb[0] + " GB - " + storagePercent;
                                $('#storageSpan').html(storageText);
                                $('#storageUsage').css({width:storagePercent});

                                if (realtime === "on")
                                    setTimeout(update, updateInterval);
                            }
                        }
                    });

                }

                //INITIALIZE REALTIME DATA FETCHING
                if (realtime === "on") {
                    update();
                }
                //REALTIME TOGGLE
                $("#realtime .btn").click(function() {
                    if ($(this).data("toggle") === "on") {
                        realtime = "on";
                    }
                    else {
                        realtime = "off";
                    }
                    update();
                });
                /*
                 * END INTERACTIVE CHART
                 */

                // header stat
                function updateHeaderStat() {
                    $.ajax({
                        url: 'InfoDB',
                        type: 'get',
                        success: function(data) {
                            if(data.indexOf('E:') > -1){
                                alert(data);
                                return;
                            }else{
                                var info = JSON.parse(data);
                                $('#indexedBinFunH').html(info.sizeBinary + '/' +info.sizeFunction);
                                $('#indexedBloH').html(info.sizeBlock);
                                $('#userH').html(info.sizeUser);


                            }
                        }
                    });

                }




                $('#userBoxRefresh').click();
                $('#binaryBoxRefresh').click();
                $('#jobBoxRefresh').click();
                updateHeaderStat();

            });
		</script>
    </body>
</html>